<?php 
$filename ="Victimizacion.xls";
header("Content-type: application/vnd.ms-excel; charset=utf-8");
header('Content-type: application/ms-excel');
header('Content-Disposition: attachment; filename='.$filename);
//set_time_limit(0);
//ini_set('memory_limit','128M');
$txtPrefijoRuta = "../../";
include( $txtPrefijoRuta . "recursos/archivos/lecturaConfiguracion.php" );
include( $txtPrefijoRuta . $arrConfiguracion['librerias']['funciones'] . "funciones.php" );
include( $txtPrefijoRuta . $arrConfiguracion['carpetas']['recursos'] . "archivos/coneccionBaseDatos.php" );

// CONSULTA FINAL (OK)
$qryHogar = "SELECT seqFormulario, T_FRM_FORMULARIO.seqEstadoProceso, seqEtapa, bolDesplazado
			FROM T_FRM_FORMULARIO INNER JOIN T_FRM_ESTADO_PROCESO ON (T_FRM_FORMULARIO.seqEstadoProceso = T_FRM_ESTADO_PROCESO.seqEstadoProceso)
			WHERE seqFormulario IN (147322, 136727, 57311, 105020, 119228, 58150, 148783, 106869, 148808, 20038, 157398, 128340, 155397, 104825, 48560, 16425, 10217, 61991, 140250, 2329, 50283, 131826, 152748, 139533, 107611, 50296, 11525, 157983, 33987, 120427, 2905, 3447, 3607, 172419, 48287, 74504, 49832, 107907, 19531, 20126, 16222, 184508, 28039, 74650, 23008, 121852, 49675, 183703, 193484, 196018, 61369, 199876, 17786, 206527, 129165, 15158, 41364, 73824, 52418, 62239, 80035, 82782, 16605, 28774, 183393, 195651, 204824, 23001, 173060, 176433, 14303, 9850, 151909, 29653, 213422, 24390, 219659, 11525, 73528, 21391, 223850, 18623, 194790, 227222, 203825, 12962, 223007, 133612, 104996, 76466, 117056, 40750, 31539, 69356, 207988, 111587, 226242, 218908, 196849, 203734, 95206, 207408, 186963, 216327, 193358, 19882, 237791, 193293, 234516, 190093, 179606, 198315, 227360, 197881, 111421, 204097, 207866, 198221, 195300, 200627, 197082, 198994, 225023, 211361, 233124, 210839, 208291, 205635, 202496, 199755, 215127, 178177, 237752, 150794, 200896, 197552, 49639, 204287, 209097, 210365, 218471, 6729, 6729, 232840, 205156, 231299, 177279, 229138, 215155, 231194, 207444, 199584, 160877, 205803, 230666, 227455, 102471, 226676, 237737, 228976, 217955, 121550, 177505, 200993, 229607, 197675, 213614, 51466, 237047, 68794, 227924, 210106, 13279, 179794, 224855, 231840, 207914, 200642, 203232, 197058, 10921, 217761, 215169, 232544, 25933, 135089, 233830, 194447, 202336, 198925, 196694, 227662, 227554, 91435, 200868, 233192, 208751, 226875, 219822, 205258, 237365, 67931, 200567, 218449, 217913, 218114, 101445, 233528, 18030, 67789, 237644, 49850, 228453, 204313, 237162, 205057, 231895, 233194, 178999, 209022, 235534, 221188, 237399, 182407, 237263, 236581, 217926, 51658, 197418, 214841, 218409, 112455, 229999, 208337, 230144, 234308, 192724, 183883, 229345, 211256, 217876, 192132, 221548, 215958, 50881, 120091, 230082, 211725, 165017, 212436, 216981, 182306, 217528, 229068, 215364, 226340, 236153, 222345, 225207, 234289, 21548, 183666, 170215, 220219, 230178, 217933, 204319, 221318, 219643, 220382, 233055, 179474, 234961, 208791, 211287, 227032, 37813, 37476, 186362, 224909, 237591, 216254, 235033, 233708, 220248, 220246, 195696, 224098, 228415, 217668, 216237, 218372, 236811, 210328, 214776, 226778, 220249, 230031, 189528, 107598, 90703, 155145, 164773, 232793, 229561, 233127, 197292, 200819, 230625, 233074, 235754, 221643, 221367, 235055, 226841, 197923, 205599, 108704, 197132, 216861, 200312, 220453, 231082, 227165, 195832, 222120, 198076, 180263, 224874, 143352, 198316, 222955, 225875, 215383, 200488, 198777, 178162, 233780, 205132, 235110, 217451, 222073, 200912, 227992, 226598, 136527, 221577, 38578, 205932, 11525, 208306, 203024, 204295, 213050, 152729, 199105, 214992, 229387, 229386, 197725, 228227, 201311, 81110, 189839, 133260, 229835, 229592, 201034, 217059, 125336, 234574, 229640, 228631, 51430, 234542, 235317, 213977, 203492, 205727, 235085, 221665, 228419, 225363, 216436, 216032, 215389, 233318, 229325, 235438, 172060, 27340, 203395, 63094, 222511, 233216, 204056, 222250, 197524, 232574, 52418, 236399, 236740, 199123, 75083, 231216, 221152, 234028, 209891, 203753, 237179, 192986, 72649, 150194, 222031, 236417, 237303, 17926, 200182, 234477, 229828, 233960, 160410, 237657, 201219, 237364, 232082, 107442, 230575, 230740, 47294, 209874, 217194, 180478, 201597, 217067, 233187, 213904, 230087, 217463, 230703, 219974, 14285, 233675, 211002, 223022, 227407, 234614, 212939, 200461, 18730, 10763, 169414, 169020, 46538, 30232, 229596, 233137, 235595, 14188, 103412, 220894, 211663, 217484, 191846, 215289, 226954, 99512, 217406, 231905, 210684, 229512, 236948, 176121, 222051, 46470, 11432, 214342, 233711, 236097, 200644, 232584, 229821, 230250, 198641, 16521, 28447, 183925, 236818, 9497, 230254, 229000, 233500, 11397, 214274, 228472, 85041, 224731, 97242, 85312, 120359, 230041, 214205, 222021, 204683, 15782, 61557, 233871, 208712, 225541, 229952, 64022, 63353, 199516, 206400, 65103, 43722, 42319, 116557, 12769, 16665, 230254, 232297, 237544, 198155, 229682, 234912, 73824, 164337, 199800, 227852, 233731, 224189, 18647, 194126, 234423, 238229, 51518, 115546, 43913, 235494, 28958, 72519, 77097, 199202, 199206, 220732, 216894, 196050, 216166, 222267, 115593, 46886, 235775, 235562, 237429, 112641, 48411, 62703, 237171, 229448, 221934, 207847, 235583, 46618, 20983, 61433, 22699, 179181, 22361, 99680, 107752, 230563, 163509, 17148, 227694, 153986, 203122, 226194, 234368, 230613, 216857, 233702, 145486, 224242, 203782, 219062, 234373, 237552, 229977, 223168, 218202, 206229, 106946, 228971, 19961, 231468, 62698, 220534, 235502, 226803, 142362, 225250, 236710, 98090, 230928, 195303, 213482, 219834, 228540, 251844, 229914, 209542, 196785, 226759, 220735, 200368, 53644, 217927, 232422, 167142, 217501, 222601, 70730, 220276)
";

$exeQueryHogar = mysql_query($qryHogar);

// RECORRIENDO LOS MIEMBROS POR HOGAR

print_r("<table width='50%' align='center' cellpadding=0 cellspacing=0 border=0>");
print_r ("<tr><td>Formulario</td><td>Etapa</td><td>Estado Proceso</td><td>Hogar Desplazado</td><td>Miembros del hogar</td><td>desp forzado</td><td>otros</td></tr>");

while ($rowHogar = mysql_fetch_array($exeQueryHogar)) {
//print_r ("<tr><td>$rowHogar[seqFormulario]</td></tr>");
$n = 0;
	$qryCalifica = "SELECT c.seqCiudadano,
						numDocumento,
						seqTipoVictima,
						seqParentesco
					FROM T_CIU_CIUDADANO c
						LEFT JOIN T_FRM_HOGAR h ON (c.seqCiudadano = h.seqCiudadano)
						LEFT JOIN T_FRM_FORMULARIO f ON (h.seqFormulario = f.seqFormulario)
					WHERE f.seqFormulario = $rowHogar[seqFormulario]";
	
	//echo $qryCalifica."<br>";
	$exeCalifica = mysql_query($qryCalifica);
	$victima = 0;
	$novictima = 0;
	while ($rowCalifica = mysql_fetch_array($exeCalifica)) { 
	$n = $n + 1;
		if ($rowCalifica[seqTipoVictima] != 2 ){ // Es desplazamiento Forzado -> Hogar Vicitma
			$novictima = $novictima + 1;
		} else {
			$victima = $victima + 1;
		}
	} // FIN RECORRIDO DE INTEGRANTES DEL HOGAR
	print_r ("<tr><td>$rowHogar[seqFormulario]</td><td>$rowHogar[seqEtapa]</td><td>$rowHogar[seqEstadoProceso]</td><td>$rowHogar[bolDesplazado]</td><td>$n</td><td>$victima</td><td>$novictima</td></tr>");
}
print_r ("</table>");
?>